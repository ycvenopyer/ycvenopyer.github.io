<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="2024 Fall Compiler Review, ycvenopyer&#39;s Blogs">
    <meta name="description" content="参考：编译原理课程笔记（All-in-One速通版）
1.词法分析1.1 正则表达式1.2 有穷自动机NFA
DFA
NFA到DFA的转化：子集构造法（闭包）
DFA最小化：可区分状态的计算
2.语法分析2.1 语法分析器从词法分析器获得T">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>2024 Fall Compiler Review | ycvenopyer&#39;s Blogs</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="ycvenopyer's Blogs" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">ycvenopyer&#39;s Blogs</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">ycvenopyer&#39;s Blogs</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/ycvenopyer" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Follow Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/ycvenopyer" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Follow Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/12.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">2024 Fall Compiler Review</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Compiler/">
                                <span class="chip bg-color">Compiler</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Programming/" class="post-category">
                                Programming
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-12-26
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-12-28
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    10.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    37 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>参考：<a target="_blank" rel="noopener" href="https://cubicy.icu/compiler-construction-principles/">编译原理课程笔记（All-in-One速通版）</a></p>
<h2 id="1-词法分析"><a href="#1-词法分析" class="headerlink" title="1.词法分析"></a>1.词法分析</h2><h3 id="1-1-正则表达式"><a href="#1-1-正则表达式" class="headerlink" title="1.1 正则表达式"></a>1.1 正则表达式</h3><h3 id="1-2-有穷自动机"><a href="#1-2-有穷自动机" class="headerlink" title="1.2 有穷自动机"></a>1.2 有穷自动机</h3><p>NFA</p>
<p>DFA</p>
<p>NFA到DFA的转化：子集构造法（闭包）</p>
<p>DFA最小化：可区分状态的计算</p>
<h2 id="2-语法分析"><a href="#2-语法分析" class="headerlink" title="2.语法分析"></a>2.语法分析</h2><h3 id="2-1-语法分析器"><a href="#2-1-语法分析器" class="headerlink" title="2.1 语法分析器"></a>2.1 语法分析器</h3><p>从词法分析器获得Token序列，确认该序列是否可以由语言的文法生成。</p>
<ul>
<li>对于语法错误的程序，报告错误信息</li>
<li>对于语法正确的程序，生成语法分析树</li>
</ul>
<h3 id="2-2-上下文无关文法CFG"><a href="#2-2-上下文无关文法CFG" class="headerlink" title="2.2 上下文无关文法CFG"></a>2.2 上下文无关文法CFG</h3><p>终结符，非终结符，开始符号，产生式</p>
<p>推导和归约：逆过程</p>
<p>最左推导，最右推导，最左归约，最右规约</p>
<p>在自顶向下的分析中，总是采用<strong>最左推导</strong>；在自底向上的分析中，总是采用<strong>最左归约</strong></p>
<p>句型：文法G下可能推导出的一个符号序列，包含终结符&#x2F;非终结符，可以为空。</p>
<p>句子：只包含终结符的句型。</p>
<p>语言：文法G可产生的所有句子的集合。</p>
<p>正则文法VS上下文无关文法</p>
<p>Chomsky范式：</p>
<ul>
<li>0型文法&#x3D;短语结构文法 递归可枚举</li>
<li>1型文法&#x3D;上下文有关文法</li>
<li>2型文法&#x3D;CFG</li>
<li>3型文法&#x3D;RE</li>
</ul>
<h3 id="2-3-CFG的分析树Parse-Tree"><a href="#2-3-CFG的分析树Parse-Tree" class="headerlink" title="2.3 CFG的分析树Parse Tree"></a>2.3 CFG的分析树Parse Tree</h3><p>根节点&#x3D;文法初始符号；叶节点&#x3D;终结符；内部节点&#x3D;非终结符；父节点-&gt;{叶节点}&#x3D;产生式</p>
<h3 id="2-4-编程语言的文法设计"><a href="#2-4-编程语言的文法设计" class="headerlink" title="2.4 编程语言的文法设计"></a>2.4 编程语言的文法设计</h3><p>核心：无二义性</p>
<p>二义性来源：存在两个不同的最左推导</p>
<p>解决方法：确保只有一种最左推导，规定符号优先级，规定符号结合性</p>
<h3 id="2-5-自顶向下"><a href="#2-5-自顶向下" class="headerlink" title="2.5 自顶向下"></a>2.5 自顶向下</h3><p>每一步需要考虑：</p>
<ul>
<li>替换哪个非终结符</li>
<li>应用哪个产生式替换</li>
</ul>
<h4 id="2-5-1-递归下降分析"><a href="#2-5-1-递归下降分析" class="headerlink" title="2.5.1 递归下降分析"></a>2.5.1 递归下降分析</h4><p>适用于LL(k)文法</p>
<p>从根节点开始，尝试应用一个产生式，产生一个句型；递归下降到下一层，对句型中非终结符也尝试一个产生式；发生错误则选择其他的产生式，如果所有产生式都错误，失败，回溯到上层选择其他产生式。太慢！</p>
<h4 id="2-5-2-LL（1）和预测分析法"><a href="#2-5-2-LL（1）和预测分析法" class="headerlink" title="2.5.2 LL（1）和预测分析法"></a>2.5.2 LL（1）和预测分析法</h4><p>预测分析法：接收LL（k）文法</p>
<ul>
<li>第一个L: “left to right” 从左到右扫描</li>
<li>第二个L: “left-most derivation” 最左推导</li>
<li>k: 向前看k个token确定推导选用的产生式（一般不明确说k就是k&#x3D;1）</li>
</ul>
<p>这里添加了约束使其无需回溯！</p>
<p>FISRT集和FOLLOW集：</p>
<p>LL(1)预测分析实现方式：计算First,Follow-&gt;构造预测分析表-&gt;预测分析</p>
<p>在预测分析表中，如果某一格存在多个产生式，就说明无法确定选取哪个产生式（也即：产生了冲突），也就说明不是LL(1)文法！</p>
<blockquote>
<p>LL（1）的优劣：</p>
<ul>
<li>运行高效</li>
<li>递归实现符合文法结构、适合手动构造&amp;自动生成</li>
<li>能分析的文法类型受限</li>
</ul>
</blockquote>
<h4 id="2-5-3-消除左递归、提左公因子"><a href="#2-5-3-消除左递归、提左公因子" class="headerlink" title="2.5.3 消除左递归、提左公因子"></a>2.5.3 消除左递归、提左公因子</h4><p>LL（1）文法是无二义性、无左递归、无左公因子的。</p>
<p>左递归文法：有非终结符A使得$A\Rightarrow* A\alpha$，形如$S\rightarrow Sa$的称为立即&#x2F;直接左递归。</p>
<p><img src="/2024/12/26/compiler-review/image-20241218103228714.png" alt="1"></p>
<p>左公因子的文法：$P\rightarrow \alpha\beta|\alpha\gamma$</p>
<p>同一非终结符的多个候选式存在共同前缀，可能导致回溯。</p>
<p>解决：$P\rightarrow \alpha Q,Q\rightarrow \beta|\gamma$</p>
<h4 id="2-5-4-错误恢复"><a href="#2-5-4-错误恢复" class="headerlink" title="2.5.4 错误恢复"></a>2.5.4 错误恢复</h4><h3 id="2-6-自底向上"><a href="#2-6-自底向上" class="headerlink" title="2.6 自底向上"></a>2.6 自底向上</h3><p>从串w归约为文法开始符号S的过程。</p>
<p>需要考虑：</p>
<ul>
<li>何时归约（归约哪些符号串？）</li>
<li>归约到哪个非终结符号？</li>
</ul>
<p><img src="https://cubicy.icu/compiler-construction-principles/grammars.png" alt="grammars"></p>
<p>LR（k）文法：</p>
<ul>
<li>每一个LL（k）语法也是LR（k）的</li>
<li>不要求无左公因式</li>
<li>可以处理左递归文法</li>
<li>“L”: left-to-right scanning 自左向右扫描</li>
<li>“R”: right-most derivation in reverse 最右推导的逆</li>
<li>“k”: 向前看的字符的个数(k省略时取1)</li>
<li>子集（详见<a target="_blank" rel="noopener" href="https://cubicy.icu/compiler-construction-principles/#grammars-set">该图</a>）：LR(1), LALR(1), SLR, LR(0), …</li>
</ul>
<h4 id="2-6-1-移进——归约Shift-Reduce"><a href="#2-6-1-移进——归约Shift-Reduce" class="headerlink" title="2.6.1 移进——归约Shift-Reduce"></a>2.6.1 移进——归约Shift-Reduce</h4><p>核心：将字符串一分为二。右侧是未被parser检查的，左侧包含终结符与非终结符。</p>
<p><img src="https://cubicy.icu/compiler-construction-principles/sr.png" alt="shift reduce"></p>
<p>LR分析采用最右推导的逆过程——最左归约。</p>
<p>采用栈进行移进归约。</p>
<p>表驱动的LR分析。</p>
<h4 id="2-6-2-LR（0）"><a href="#2-6-2-LR（0）" class="headerlink" title="2.6.2 LR（0）"></a>2.6.2 LR（0）</h4><p>核心：维护栈顶内容对于所有产生式右侧的进度。</p>
<p>项：一个产生式加上其在某处的一个点</p>
<p>LR（0）自动机的构造：DFA与分析表</p>
<p>GOTO集合</p>
<p><img src="https://cubicy.icu/compiler-construction-principles/lr-dfa-eg.png" alt="lr-dfa example"></p>
<p>DFA到分析表：Action表项和Goto表项</p>
<p><img src="/2024/12/26/compiler-review/image-20241218114809116.png" alt="2"></p>
<p><img src="https://cubicy.icu/compiler-construction-principles/lr0-stack-table.png" alt="lr0-stack-table"></p>
<p>LR实际上只有状态栈，符号信息可从相应状态中获取。</p>
<p>对于LR（0）中的0：项中没有向前看符号等信息，不关心后面的token，是否规约&#x2F;使用何产生式规约完全取决于栈顶状态。</p>
<p>局限性：移进——规约冲突。</p>
<h4 id="2-6-3-SLR（1）"><a href="#2-6-3-SLR（1）" class="headerlink" title="2.6.3 SLR（1）"></a>2.6.3 SLR（1）</h4><p>SLR（1）&#x3D;Simple LR（1），称为SLR文法，其实就是对LR（0）稍微修改</p>
<p>SLR的DFA和LR（0）的一样，但LR（0）的分析表中有一些规约是非法的，需要删去。</p>
<p> 在生成分析表的具体步骤上：</p>
<ul>
<li>LR(0)的某些状态包含可规约的Item，那么这个状态I在对应的Action表中T[I,_]这一行的每一个格子（无论终结符t是什么）无论如何都会有对应的rnrn项</li>
<li>SLR会关心后面的终结符是什么，因此如果t不在Follow集中，这不能是一个合法的规约，Action表对应的t列就不会有这个$r_n$</li>
</ul>
<p>局限性：不能消除所有移进规约冲突，如果产生冲突对应的终结符t恰好在Follow集中，就无法消除。</p>
<h4 id="2-6-4-LR（1）"><a href="#2-6-4-LR（1）" class="headerlink" title="2.6.4 LR（1）"></a>2.6.4 LR（1）</h4><p>包含后继token来消除一些规约动作。相当于分裂一些LR（0）的状态，精确指明何时应该规约。</p>
<p>LR（1）项的形式：$A\rightarrow \alpha\cdot\beta,a$</p>
<p>逗号后的a是向前看符号，即表明向前看一个终结符，可以是$</p>
<p>计算Closure，Goto表，Action表</p>
<p><img src="https://cubicy.icu/compiler-construction-principles/lr1-items.png" alt="lr1 items"></p>
<p>局限性：这样的文法限制过少，过于灵活，导致状态数量过多，状态表过于庞大。</p>
<p>话虽如此，文法仍然可能因为RR冲突和SR冲突而导致其不属于LR（1）！</p>
<p>所以在SLR（1）和LR（1）之间折中得到了LALR（1）</p>
<h4 id="2-6-5-LALR（1）"><a href="#2-6-5-LALR（1）" class="headerlink" title="2.6.5 LALR（1）"></a>2.6.5 LALR（1）</h4><p>LALR &#x3D; Look-Ahead LR，把LR（1）中只有向前看符号不同的项合并。</p>
<p>定义：把LR（1）中项的集合里所有向前看符号去掉，剩下的称为核，把LR（1）中所有核相同的状态两两合并为一个状态。新状态的项是两个旧状态的项的并。</p>
<p>代价：可能有RR冲突。</p>
<h3 id="2-7-语法分析杂项"><a href="#2-7-语法分析杂项" class="headerlink" title="2.7 语法分析杂项"></a>2.7 语法分析杂项</h3><h4 id="2-7-1-YACC"><a href="#2-7-1-YACC" class="headerlink" title="2.7.1 YACC"></a>2.7.1 YACC</h4><p>yacc&#x3D;yet another compiler-compiler</p>
<ul>
<li>基于LALR（1）</li>
<li>BNF范式</li>
<li>GNU版本名为Bison</li>
<li>流程：</li>
</ul>
<ol>
<li>Yacc源程序(*.y) &gt;&gt; Yacc Compiler &gt;&gt; C语言实现的LALR分析器(y.tab.c)</li>
<li>y.tab.c &gt;&gt; C Compiler &gt;&gt; 分析器可执行文件(<em>.exe&#x2F;</em>.out)</li>
<li>输入 &gt;&gt; 分析器可执行文件 &gt;&gt; 输出</li>
</ol>
<p>消除二义性与解决冲突</p>
<ul>
<li>消除二义性：<ul>
<li>指定运算符优先级：先出现的优先</li>
<li>指定运算符结合律：<code>%left</code>（左结合，例如乘法加法） <code>%right</code>（右结合，例如一元运算符负号）</li>
</ul>
</li>
<li>冲突解决<ul>
<li>规约-规约冲突：先出现的产生式优先采用</li>
<li>移进-规约冲突：移进优先采用</li>
</ul>
</li>
<li>更通用的方法：通过改写文法，可以在消除冲突的同时减少二义性</li>
</ul>
<h4 id="2-7-2-错误恢复（续）"><a href="#2-7-2-错误恢复（续）" class="headerlink" title="2.7.2 错误恢复（续）"></a>2.7.2 错误恢复（续）</h4><ul>
<li>局部错误恢复：调整Parse过程的栈，使其恢复到正常从而继续进行Parsing</li>
<li>全局错误恢复：删除&#x2F;插入尽可能少的字符，使得源字符串成为合法的字符串</li>
</ul>
<h3 id="2-8-语法分析小结：文法对比"><a href="#2-8-语法分析小结：文法对比" class="headerlink" title="2.8 语法分析小结：文法对比"></a>2.8 语法分析小结：文法对比</h3><h4 id="2-8-1-SLR和LR（0）"><a href="#2-8-1-SLR和LR（0）" class="headerlink" title="2.8.1 SLR和LR（0）"></a>2.8.1 SLR和LR（0）</h4><p><img src="/2024/12/26/compiler-review/image-20241218205629813.png" alt="3"></p>
<h4 id="2-8-2-LL（1）和LR（1）"><a href="#2-8-2-LL（1）和LR（1）" class="headerlink" title="2.8.2 LL（1）和LR（1）"></a>2.8.2 LL（1）和LR（1）</h4><p><img src="/2024/12/26/compiler-review/image-20241218205740360.png" alt="4"></p>
<h4 id="2-8-3-LL（1）-LR（1）-SLR"><a href="#2-8-3-LL（1）-LR（1）-SLR" class="headerlink" title="2.8.3 LL（1） LR（1） SLR"></a>2.8.3 LL（1） LR（1） SLR</h4><p><img src="https://cubicy.icu/compiler-construction-principles/grammar-compare.png" alt="grammar-compare"></p>
<h3 id="2-9-抽象语法"><a href="#2-9-抽象语法" class="headerlink" title="2.9 抽象语法"></a>2.9 抽象语法</h3><h4 id="2-9-1-属性文法"><a href="#2-9-1-属性文法" class="headerlink" title="2.9.1 属性文法"></a>2.9.1 属性文法</h4><p>属性文法&#x3D;CFG+属性+属性计算规则</p>
<ul>
<li>属性:&#x3D; 描述文法符号的语义特征，比如表达式E的值可以记为E.val</li>
<li>属性计算规则(语义规则):&#x3D; 与产生式相关联、反映文法符号属性之间关系的规则，比如在乘法表达式中左侧的E.val要如何计算<ul>
<li>仅表明属性间“抽象”关系，不涉及计算次序等具体实现细节</li>
</ul>
</li>
<li>应用：<ul>
<li>“推导类”：例如很多语言的<strong>编译期求值</strong></li>
<li>“生成类”：生成AST， 中间代码等</li>
<li>…</li>
</ul>
</li>
<li>实现：例如在先前章节中Yacc等Parser生成器的<strong>语义动作</strong></li>
</ul>
<h4 id="2-9-2-语义动作"><a href="#2-9-2-语义动作" class="headerlink" title="2.9.2 语义动作"></a>2.9.2 语义动作</h4><p>我们可以给产生式绑定一个语义动作，使得按照这个产生式规约时&#x2F;推导时完成特定操作。</p>
<p>每个token都可能有独属于自己的 <strong>语义值(Semantic Value)</strong> 。每种token的语义值类型可以不同，我们把A的语义值的类型称为“A的关联类型”。</p>
<p>例如对于产生式 A→B C D</p>
<ul>
<li>语义动作返回值必须是<em>A的关联类型</em></li>
<li>这个值可以通过B C D各自的语义值进行运算得出</li>
</ul>
<h4 id="2-9-3-抽象解析树APT"><a href="#2-9-3-抽象解析树APT" class="headerlink" title="2.9.3 抽象解析树APT"></a>2.9.3 抽象解析树APT</h4><p>APT &#x3D; Abstract Parse Tree 是语义动作的一种应用。</p>
<p>能否<strong>通过描述语义动作直接实现整个编译器</strong>？可以，但是难以维护，且必须保证这些语义值的计算顺序和Parsing顺序完全一致。</p>
<ul>
<li>考虑分离语法解析（Parsing）和语义动作：一个可行方案是Parsing得到树，而后遍历以进行语义相关的操作。</li>
</ul>
<p>我们可以很容易得到一棵树：叶节点对应输入的token，内部节点对应一个语法规则。这被称为<strong>concrete parse tree</strong>.</p>
<p><img src="https://cubicy.icu/compiler-construction-principles/concrete-pt.png" alt="concrete-pt"></p>
<h4 id="2-9-4-抽象语法树AST"><a href="#2-9-4-抽象语法树AST" class="headerlink" title="2.9.4 抽象语法树AST"></a>2.9.4 抽象语法树AST</h4><p>可以提供一个<em>干净的</em>（不包含Parsing的那些繁文缛节）接口用于后续编译流程的实现或优化（编译器后端）。</p>
<p>生成方式：用<strong>具体语法</strong>（Parser生成器能懂的）为<strong>抽象语法</strong>（我们想要的、更可读的）生成抽象语法树：</p>
<p><img src="https://cubicy.icu/compiler-construction-principles/AST.png" alt="AST"></p>
<ul>
<li><p>为每一个非终结符定义一个类型声明，用于表示其关联类型。</p>
</li>
<li><p>产生式统一放进一个union里，每一个产生式就是union里的一个结构体，这个结构体用于储存其子节点：<br><img src="https://cubicy.icu/compiler-construction-principles/AST-def.png" alt="AST definition"></p>
</li>
<li><p>为每个产生式定义一个函数，除了计算需要的语义值返回以外，还将申请空间、分配新的树节点并设置好其子节点：</p>
<p><img src="https://cubicy.icu/compiler-construction-principles/AST-impl.png" alt="AST implementation"></p>
</li>
</ul>
<h2 id="3-语义分析"><a href="#3-语义分析" class="headerlink" title="3.语义分析"></a>3.语义分析</h2><p>SDD是将文法符号和某些属性相关联，并通过语义规则来描述如何计算属性的值。</p>
<p>SDT在产生式体中加入语义动作，并在适当的时候执行这些语义动作。</p>
<h3 id="3-1-语法制导定义SDD"><a href="#3-1-语法制导定义SDD" class="headerlink" title="3.1 语法制导定义SDD"></a>3.1 语法制导定义SDD</h3><p>SDD是上下文无关文法和属性&#x2F;规则的结合。</p>
<ul>
<li>属性和文法符号相关联，按照需要来确定各个文法符号需要哪些属性</li>
<li>规则和产生式相关联</li>
</ul>
<p>对于文法符号X和属性a，用X.a表示分析树中的某个标号为X的节点的值。</p>
<p>一个分析树节点和它的分支对应于一个产生式规则，而对应的语义规则确定了这些节点上的属性的取值。</p>
<h4 id="3-1-1-分析树和属性值"><a href="#3-1-1-分析树和属性值" class="headerlink" title="3.1.1 分析树和属性值"></a>3.1.1 分析树和属性值</h4><p>假设我们需要知道一个表达式的类型，以及对应代码将它的值存放在何处，我们就需要两个属性：type,place</p>
<p><img src="/2024/12/26/compiler-review/image-20241228211612914.png" alt="5"></p>
<h4 id="3-1-2-继承属性和综合属性"><a href="#3-1-2-继承属性和综合属性" class="headerlink" title="3.1.2 继承属性和综合属性"></a>3.1.2 继承属性和综合属性</h4><p>综合属性：在分许树节点N上的非终结符号A的属性值由N对应的产生式所关联的语义规则来定义。通过N的子节点或N本身的属性值来定义。</p>
<p>继承属性：节点N的属性值由N的父节点所关联的语义规则来定义。依赖于N的父节点、N本身和N的兄弟节点上的属性值。</p>
<p>不允许N的继承属性通过N的子节点上的属性来定义。但是允许N的综合属性依赖于N本身的继承属性。</p>
<p>终结符号有综合属性，但是没有继承属性。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228211957756.png" alt="6"></p>
<h4 id="3-1-3-S属性的SDD"><a href="#3-1-3-S属性的SDD" class="headerlink" title="3.1.3 S属性的SDD"></a>3.1.3 S属性的SDD</h4><p>只包含综合属性的SDD称为S属性的SDD。每个语义规则都根据产生式体中的属性值来计算头部非终结符号的属性值。</p>
<p>S属性的SDD可以和LR语法分析器一起实现。</p>
<p>语义规则不应该有复杂的副作用。</p>
<ul>
<li>要求副作用不影响其他属性的求值</li>
<li>没有副作用的SDD称为属性文法</li>
</ul>
<h4 id="3-1-4-L属性的SDD"><a href="#3-1-4-L属性的SDD" class="headerlink" title="3.1.4 L属性的SDD"></a>3.1.4 L属性的SDD</h4><p>每个属性：</p>
<ul>
<li>要么是综合属性</li>
<li>要么是继承属性，且产生式$A\rightarrow X_1X_2\cdots X_n$中计算$X_i.a$的规则只能使用：<ul>
<li>A的继承属性</li>
<li>$X_i$左边的文法符号$X_j$的继承属性或综合属性</li>
<li>$X_i$自身的继承或综合属性，且这些属性之间的依赖关系不形成环</li>
</ul>
</li>
</ul>
<h4 id="3-1-5-语法分析树上的SDD求值"><a href="#3-1-5-语法分析树上的SDD求值" class="headerlink" title="3.1.5 语法分析树上的SDD求值"></a>3.1.5 语法分析树上的SDD求值</h4><p>注释语法分析树：包含了各个节点的各属性值的语法分析树。</p>
<p>步骤：</p>
<ul>
<li>对于任意的输入串，首先构造出相应的分析树。</li>
<li>给各个结点（根据其文法符号）加上相应的属性值</li>
<li>按照语义规则计算这些属性值即可</li>
</ul>
<p><img src="/2024/12/26/compiler-review/image-20241228212714134.png" alt="7"></p>
<h4 id="3-1-6-依赖图"><a href="#3-1-6-依赖图" class="headerlink" title="3.1.6 依赖图"></a>3.1.6 依赖图</h4><p>描述了某棵特定的分析树上各个属性实例之间的信息流（计算顺序）。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228213225620.png" alt="8"></p>
<h4 id="3-1-7-属性值的计算顺序"><a href="#3-1-7-属性值的计算顺序" class="headerlink" title="3.1 7 属性值的计算顺序"></a>3.1 7 属性值的计算顺序</h4><p>各个属性的值需要按照依赖图的拓扑顺序计算，如果有环则无法计算。</p>
<p>S属性的SDD：</p>
<ul>
<li>每个属性都是综合属性</li>
<li>都是根据子构造的属性计算出父构造的属性</li>
<li>在依赖图中，总是通过子节点的属性值来计算父节点的属性值。可以和自顶向下、自底向上的语法分析过程一起计算</li>
</ul>
<p>L属性的SDD：</p>
<ul>
<li>依赖图的边：继承属性从左到右，从上到下；综合属性从下到上</li>
<li>在扫描过程中，计算一个属性值时，和它相关的依赖属性都已经计算完毕</li>
</ul>
<p>受控的副作用：</p>
<ul>
<li>不会对属性求值产生约束，即可以按照任何拓扑顺序求值，不会影响最终结果</li>
<li>或者对求值过程添加简答的约束</li>
</ul>
<h3 id="3-2-SDT的应用例子"><a href="#3-2-SDT的应用例子" class="headerlink" title="3.2 SDT的应用例子"></a>3.2 SDT的应用例子</h3><h4 id="3-2-1-抽象语法树的构造"><a href="#3-2-1-抽象语法树的构造" class="headerlink" title="3.2.1 抽象语法树的构造"></a>3.2.1 抽象语法树的构造</h4><p><img src="/2024/12/26/compiler-review/image-20241228214334048.png" alt="9"></p>
<h4 id="3-2-2-自顶向下方式处理的L属性定义"><a href="#3-2-2-自顶向下方式处理的L属性定义" class="headerlink" title="3.2.2 自顶向下方式处理的L属性定义"></a>3.2.2 自顶向下方式处理的L属性定义</h4><p>类型结构：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228214931075.png" alt="10"></p>
<p>类型的定义：类型包括两个部分：$T\rightarrow B C$</p>
<p>B是基本类型，C是分量。如：$int [3][4]$</p>
<h3 id="3-3-语法制导的翻译方案SDT"><a href="#3-3-语法制导的翻译方案SDT" class="headerlink" title="3.3 语法制导的翻译方案SDT"></a>3.3 语法制导的翻译方案SDT</h3><p>SDT是在产生式体中嵌入程序片段（语义动作）的上下文无关文法。</p>
<p>SDT的基本实现方法：</p>
<ul>
<li>建立语法分析树</li>
<li>将语义动作看成是虚拟的节点</li>
<li>从左到右、深度优先地遍历分析树，在访问虚拟节点时执行相应动作</li>
</ul>
<p>用SDT实现两类重要的SDD：</p>
<ul>
<li>基本文法是LR的，SDD是S属性的</li>
<li>基本文法是LL的，SDD是L属性的</li>
</ul>
<h4 id="3-3-1-后缀翻译方案"><a href="#3-3-1-后缀翻译方案" class="headerlink" title="3.3.1 后缀翻译方案"></a>3.3.1 后缀翻译方案</h4><p>后缀SDT：所有动作都在产生式最右端的SDT。</p>
<p>文法可以自底向上分析且SDD是S属性的，必然可以构造出后缀SDT。</p>
<p>构造方法：</p>
<ul>
<li>将每个语义规则看作是一个赋值语义动作</li>
<li>将所有的语义动作放在规则的最右端</li>
</ul>
<p><img src="/2024/12/26/compiler-review/image-20241228222737039.png" alt="11"></p>
<p>后缀SDT的栈实现：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228222857499.png" alt="12"></p>
<p>产生式内部带有语义动作的SDT</p>
<p>消除左递归时SDT的转换</p>
<h4 id="3-3-2-L属性定义的SDT"><a href="#3-3-2-L属性定义的SDT" class="headerlink" title="3.3.2 L属性定义的SDT"></a>3.3.2 L属性定义的SDT</h4><p>将L属性的SDD转换为SDT：</p>
<ul>
<li>将每个语义规则看作是一个赋值语义动作</li>
<li>将赋值语义动作放到相应产生式的适当位置<ul>
<li>计算A的继承属性的动作插入到产生式体中对应的A的左边</li>
<li>计算产生式头的综合属性的动作在产生式的最右边</li>
</ul>
</li>
</ul>
<p><img src="/2024/12/26/compiler-review/image-20241228223441213.png" alt="13"></p>
<p><img src="/2024/12/26/compiler-review/image-20241228223511784.png" alt="14"></p>
<h4 id="3-3-3-递归下降法实现L属性的SDD"><a href="#3-3-3-递归下降法实现L属性的SDD" class="headerlink" title="3.3.3 递归下降法实现L属性的SDD"></a>3.3.3 递归下降法实现L属性的SDD</h4><p><img src="/2024/12/26/compiler-review/image-20241228223656073.png" alt="15"></p>
<p><img src="/2024/12/26/compiler-review/image-20241228223709170.png" alt="16"></p>
<p>边扫描边生成属性：当属性值的体积很大时，可以逐步生成属性的各个部分，并增量式添加到最终的属性值中。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228223743158.png" alt="17"></p>
<h2 id="4-中间代码生成"><a href="#4-中间代码生成" class="headerlink" title="4.中间代码生成"></a>4.中间代码生成</h2><p>本章主要包括中间代码表示（抽象语法树和三地址代码）以及中间代码生成（表达式、类型检查、控制流）。</p>
<p>抽象语法树在语法分析已经讲过，静态类型检查和中间代码生成的过程都可以用语法制导的翻译来描述和实现。</p>
<h3 id="4-1-表达式的DAG"><a href="#4-1-表达式的DAG" class="headerlink" title="4.1 表达式的DAG"></a>4.1 表达式的DAG</h3><p>表达式的DAG能够指出表达式中的公共子表达式。</p>
<p>构造：可以用和构造AST一样的SDD来构造。</p>
<h3 id="4-2-三地址代码"><a href="#4-2-三地址代码" class="headerlink" title="4.2 三地址代码"></a>4.2 三地址代码</h3><p>一般写成：x &#x3D; y op z</p>
<p>运算分量：源程序中的名字作为三地址代码的地址；源程序中出现或生成的常量作为常量；还有编译器生成的临时变量。</p>
<p>指令集合：运算&#x2F;赋值指令；复制指令；无条件跳转指令；条件转移指令；过程调用&#x2F;返回；带下标的复制指令；地址&#x2F;指针赋值指令。</p>
<p>实例：</p>
<p><img src="/2024/12/26/compiler-review/image-20241226141240698.png" alt="18"></p>
<p>三地址指令的四元式表示方法： op  arg1  arg2  result</p>
<ul>
<li>op是运算符的内部编码</li>
<li>arg1,arg2,result是地址</li>
<li>如：x &#x3D; y + z $\Rightarrow$ + y z x</li>
<li>单目运算符不使用arg2</li>
<li>param运算不使用arg2和result</li>
<li>条件转移和非条件转移将目标符号放在result字段</li>
</ul>
<p>实例：</p>
<p><img src="/2024/12/26/compiler-review/image-20241226141818374.png" alt="19"></p>
<p>三地址的三元式表示方法： op  arg1  arg2</p>
<ul>
<li>x[i] &#x3D; y需要拆分成两个三元式：求x[i]的地址，然后再赋值</li>
<li>x &#x3D; y op z需要拆分为：<ul>
<li>（？（Line Number）） op y z</li>
<li>​                                             &#x3D;  x ?</li>
</ul>
</li>
</ul>
<h3 id="4-3-类型检查"><a href="#4-3-类型检查" class="headerlink" title="4.3 类型检查"></a>4.3 类型检查</h3><p>确定名字的类型和变量的存储空间布局（相对地址）。</p>
<p>类型表达式</p>
<p>结构等价和名等价</p>
<p>计算类型和宽度的SDT（type,width）</p>
<p>声明序列的SDT（还有符号表中的位置，offset）</p>
<p>表达式代码的SDD</p>
<ul>
<li>属性code表达代码</li>
<li>addr表示存放表达式结果的地址</li>
<li>new temp()可以生成一个临时变量</li>
<li>gen()生成一个指令</li>
</ul>
<p><img src="/2024/12/26/compiler-review/image-20241226144046254.png" alt="20"></p>
<p>数组元素的寻址：</p>
<ul>
<li>数组元素存储在一块连续的存储空间中</li>
<li>n个数组元素是0,1,…,n-1编号的</li>
<li>假设每个数组元素宽度是w，那么数组A的第i个元素的开始地址为base+i*w，base是A[0]的相对地址</li>
<li>有时下标不一定从0开始</li>
<li>上述地址的计算是按行存放的</li>
</ul>
<p>数组引用的翻译</p>
<ul>
<li>L.addr指示一个临时变量，计算数组引用的偏移量</li>
<li>L.array是一个指向数组名字对应的符号表条目的指针，L.array.base为该数组的基地址</li>
<li>L.type是L生成的子数组的类型，对于任何数组类型t，其宽度由t.width给出,t.elem给出其数组元素的类型</li>
</ul>
<p><img src="/2024/12/26/compiler-review/image-20241226145000354.png" alt="21"></p>
<p>类型系统：给每个组成部分赋予一个类型表达式；通过一组逻辑规则来表示这些类型表达式必须满足的条件</p>
<p>类型系统的分类：</p>
<ul>
<li>类型综合：根据子表示式的类型构造出表达式的类型</li>
<li>类型推导：根据语言结构的使用方式来确定该结构的类型</li>
</ul>
<p>类型转换的SDT</p>
<p>函数&#x2F;运算符的重载</p>
<h3 id="4-4-控制流语句"><a href="#4-4-控制流语句" class="headerlink" title="4.4 控制流语句"></a>4.4 控制流语句</h3><p>控制流语句的翻译：if-else语句和while语句</p>
<ul>
<li>需要将语句的翻译和布尔表达式的翻译结合在一起</li>
<li>布尔表达式是被用作语句中改变控制流的条件表达式，用来改变控制流或者计算逻辑值</li>
</ul>
<p><img src="/2024/12/26/compiler-review/image-20241226152806234.png" alt="22"></p>
<p><img src="/2024/12/26/compiler-review/image-20241226152903476.png" alt="23"></p>
<p>避免冗余的goto语句：上面的goto L3是冗余的，可以替换成</p>
<ul>
<li>减少一条goto语句</li>
<li>引入一特殊符号fall（穿越，fall through），表示不要生成任何跳转指令</li>
<li>带穿越的语义规则</li>
</ul>
<p><img src="/2024/12/26/compiler-review/image-20241226153254811.png" alt="24"></p>
<p>回填：为布尔表达式和控制流语句生成目标代码的关键问题：某些跳转指令应该跳转到哪里？</p>
<p>基本思想：例如： if(B) S</p>
<ul>
<li>记录B的代码中跳转指令goto  S.next, if … goto  S.next的位置，但是不生成跳转目标</li>
<li>这些位置被记录到B的综合属性B.falseList中</li>
<li>当S.next的值已知时（即S的代码生成完毕时），把S.nextList中的所有指令的目标都填上这个值</li>
</ul>
<p>生成跳转指令时暂时不指定跳转目标标号，而是使用列表记录这些不完整的指令；等知道正确的目标时再填写目标标号；每个列表中的指令都指向同一个目标。</p>
<p>布尔表达式的回填翻译：</p>
<ul>
<li>trueList：包含跳转指令的列表，这些指令在取值为真时执行</li>
<li>falseList：包含跳转指令的列表，这些指令在取值为假时执行</li>
<li>Makelist(i)：创建一个只包含i的列表</li>
<li>Merge(p1, p2)：将p1和p2指向的列表合并</li>
<li>Backpatch(p,i)：将i作为目标标号插入到p所指列表中的各指令中</li>
</ul>
<p>控制转移语句的回填：语句的综合属性：nextList</p>
<p>Break、Continue的处理</p>
<h2 id="5-运行时环境"><a href="#5-运行时环境" class="headerlink" title="5.运行时环境"></a>5.运行时环境</h2><h3 id="5-1-符号表"><a href="#5-1-符号表" class="headerlink" title="5.1 符号表"></a>5.1 符号表</h3><p>绑定：把类型、值等信息绑定到一个标识符上</p>
<p>环境：一些绑定的集合，体现了程序当前环境下已声明的一些变量&#x2F;函数等</p>
<p>符号表就是环境的一种实现方式。我们在遍历AST的过程中可以维护一个符号表用于语义分析。符号表中的重要组成部分就是各个局部变量及其作用域。</p>
<h3 id="5-2-存储分配的方式"><a href="#5-2-存储分配的方式" class="headerlink" title="5.2 存储分配的方式"></a>5.2 存储分配的方式</h3><p><img src="/2024/12/26/compiler-review/image-20241226094009289.png" alt="25"></p>
<p>目标程序的代码放置在代码区</p>
<p>静态区、堆区、栈区分别放置不同类型生命期的数据值</p>
<ul>
<li><p>静态分配：编译时刻。全局变量</p>
</li>
<li><p>动态分配：</p>
<ul>
<li><p>栈式存储：和过程的调用&#x2F;返回同步进行分配和回收，值的生命期和过程生命期相同</p>
</li>
<li><p>堆存储：数据对象比创建它的过程调用更长寿</p>
<p>手工进行回收</p>
<p>垃圾回收机制</p>
</li>
</ul>
</li>
</ul>
<h3 id="5-3-栈式分配"><a href="#5-3-栈式分配" class="headerlink" title="5.3 栈式分配"></a>5.3 栈式分配</h3><p>活动树：每个节点对应一个过程活动；根节点对应main的活动；过程p的某次活动对应的节点的所有子节点：此次活动调用的各个过程活动（从左到右，表示调用的先后顺序）</p>
<p>活动记录：过程调用和返回由控制栈进行管理，每个活跃的活动对应于栈中的一个活动记录；活动记录按照开始时间，从栈底到栈顶排列</p>
<p>调用代码序列：为活动记录分配空间，填写记录中的信息。返回代码序列恢复机器状态，使调用者继续运行</p>
<p>活动记录的布局规则</p>
<p><img src="/2024/12/26/compiler-review/image-20241226102330523.png" alt="26"></p>
<p>调用者&#x2F;被调用者的活动记录</p>
<p>栈中的变长数据：变长数组</p>
<p>非局部数据的访问：无嵌套和有嵌套</p>
<p>嵌套深度</p>
<p>访问链：当被调用过程需要其他地方的某个数据时需要使用访问链进行定位</p>
<p>访问链的维护：访问链的定义+作用域规则</p>
<p>显示表：提高访问效率。数组d为每个嵌套深度保留一个指针。指针d[i]指向栈中最高的、嵌套深度为i的活动记录</p>
<h3 id="5-4-堆管理"><a href="#5-4-堆管理" class="headerlink" title="5.4 堆管理"></a>5.4 堆管理</h3><p>堆空间用于存放生命周期不确定、或生存到被明确删除为止的数据对象</p>
<p>new、malloc</p>
<p>存储管理器：</p>
<ul>
<li>分配：为每个内存请求分配一段连续的、适当大小的堆空间</li>
<li>回收：把被回收的空间返回空闲空间缓冲池，以满足其他内存需求</li>
</ul>
<p>堆空间的碎片问题</p>
<p>堆空间分配方法：</p>
<ul>
<li>Best-fit:最小的满足的空间</li>
<li>First-fit:第一个满足的空间</li>
</ul>
<p>存在的问题：内存泄漏、悬空指针引用、空指针访问&#x2F;数组越界等</p>
<p>正确的编程模式：</p>
<ul>
<li>对象所有者</li>
<li>引用计数</li>
<li>基于区域的分配</li>
</ul>
<h3 id="5-5-垃圾回收"><a href="#5-5-垃圾回收" class="headerlink" title="5.5 垃圾回收"></a>5.5 垃圾回收</h3><p>垃圾的定义：</p>
<ul>
<li>狭义：不能被引用（不可达）的数据</li>
<li>广义：不需要再被引用的数据</li>
</ul>
<p>垃圾回收：自动回收不可达数据的机制</p>
<p>根集：不需要指针解引用就可以直接访问的数据，根集的成员都是可达的</p>
<p>改变可达对象集合的操作：</p>
<ul>
<li>对象分配</li>
<li>参数传递&#x2F;返回值</li>
<li>引用赋值</li>
<li>过程返回</li>
</ul>
<p>垃圾回收方法：捕获对象变得不可达的时刻，回收对象占用的空间；在需要时，标记出所有可达对象、回收其他对象</p>
<p>引用计数法</p>
<p>基于跟踪的垃圾回收（可达性分析）：</p>
<ul>
<li>标记-清扫式：直接、全面停顿。标记：从根集开始，跟踪并标记出所有可达对象；清扫：遍历整个堆区，释放不可达对象</li>
<li>标记-清扫式的优化：用一个列表记录所有已经分配的对象，不可达对象等于已分配对象减去可达对象（四种状态对应四个列表,scanned,unscanned,unreached,free）</li>
<li>压缩并标记：消除存储碎片：对可达对象进行重定位，把可达对象移动到堆区的一段，另一端空闲；空闲空间合并成单一块，分配内存时提高效率</li>
<li>拷贝回收器：堆空间被分为两个半空间，应用程序在某个半空间内分配存储，当充满这个半空间时，开始垃圾回收；回收时，可达对象被拷贝到另一个半空间；回收完成后，两个半空间角色对调</li>
</ul>
<h2 id="6-代码生成"><a href="#6-代码生成" class="headerlink" title="6.代码生成"></a>6.代码生成</h2><p>代码生成器的三个主要任务：指令选择、寄存器分配和指派、指令排序</p>
<h3 id="6-1-代码生成器设计中的问题"><a href="#6-1-代码生成器设计中的问题" class="headerlink" title="6.1 代码生成器设计中的问题"></a>6.1 代码生成器设计中的问题</h3><ul>
<li>输入IR的选择：三元式、四元式、字节代码、堆栈机代码、后缀表示、抽象语法树、DAG</li>
<li>目标程序：RISC、CISC、可重定向代码、汇编语言</li>
<li>指令选择：IR层次、指令集特性、目标代码质量</li>
<li>寄存器分配和指派</li>
<li>求值顺序</li>
</ul>
<h3 id="6-2-目标语言"><a href="#6-2-目标语言" class="headerlink" title="6.2 目标语言"></a>6.2 目标语言</h3><p>指令集：</p>
<ul>
<li><p>加载：LD dst, addr</p>
<p>把地址addr中的内容加载到dst所指寄存器</p>
</li>
<li><p>保存：ST x, r</p>
<p>把寄存器r中的内容保存到x中</p>
</li>
<li><p>计算：OP dst,  src1,  src2</p>
<p>把src1和src2中的值运算后结果存放到dst中</p>
</li>
<li><p>无条件跳转：BR L</p>
<p>控制流转向标号L的指令</p>
</li>
<li><p>条件跳转：Bcond r,  L</p>
<p>对r中的值进行测试，如果为真则转向L</p>
</li>
</ul>
<p>寻址模式：</p>
<ul>
<li>变量x:指向分配x的内存位置</li>
<li>a(r):地址是a的左值加上r中的值</li>
<li>constant(r):寄存器中内容加上前面的常数即其地址</li>
<li>*r：寄存器r的内容为其地址</li>
<li>*constant(r):r中内容加上常量所指地址中存放的值为其地址</li>
<li>常量#constant</li>
</ul>
<p>实例：</p>
<p><img src="/2024/12/26/compiler-review/image-20241226201656884.png" alt="27"></p>
<h3 id="6-3-目标代码中的地址"><a href="#6-3-目标代码中的地址" class="headerlink" title="6.3 目标代码中的地址"></a>6.3 目标代码中的地址</h3><p>如何将IR中的名字转换成为目标代码中的地址？</p>
<ul>
<li>不同的区域中的名字采用不同的寻址方式</li>
</ul>
<p>如何为过程调用和返回生成代码？</p>
<ul>
<li>静态分配和栈式分配</li>
</ul>
<p>活动记录的静态分配：每个过程静态地分配一个数据区域，过程调用时在活动纪记录中存放返回地址；过程调用结束后控制权返回。</p>
<p>活动记录的栈式分配：运行时刻才能知道一个过程的活动记录的位置。将活动记录的位置存放在寄存器中，用偏移量来访问。</p>
<p><img src="/2024/12/26/compiler-review/image-20241226203153869.png" alt="28"></p>
<h3 id="6-4-基本块和流图"><a href="#6-4-基本块和流图" class="headerlink" title="6.4 基本块和流图"></a>6.4 基本块和流图</h3><p>中间代码的流图表示法：</p>
<ul>
<li>将中间代码划分为基本块</li>
<li>控制流只能从第一个指令进入</li>
<li>除基本块的最后一个指令外，控制流不会跳转&#x2F;停机</li>
<li>节点：基本块</li>
<li>边：指明了基本块的执行顺序</li>
</ul>
<p>作用：流图可以作为优化的基础</p>
<ul>
<li>指明了基本块之间的控制流</li>
<li>可以根据流图了解到一个值是否会被使用等信息</li>
</ul>
<p>划分基本块的算法：</p>
<ul>
<li>输入：三地址指令序列</li>
<li>输出：基本块列表</li>
<li>步骤：<ul>
<li>确定基本块的首指令：第一个三地址指令；任意一个条件或无条件转移指令的目标指令；紧跟在一个条件&#x2F;无条件转移指令之后的指令</li>
<li>确定基本块：每个首指令对应一个基本块；从首指令到下一个首指令</li>
</ul>
</li>
</ul>
<p>实例：</p>
<p><img src="/2024/12/26/compiler-review/image-20241226203912543.png" alt="29"></p>
<p>变量值的使用：活跃变量</p>
<p>流图的构造：</p>
<p><img src="/2024/12/26/compiler-review/image-20241226204305097.png" alt="30"></p>
<p>循环：程序的大部分运行时间花费在循环上</p>
<h3 id="6-5-基本块的优化"><a href="#6-5-基本块的优化" class="headerlink" title="6.5 基本块的优化"></a>6.5 基本块的优化</h3><p>基本块可以用DAG表示：</p>
<ul>
<li>每个变量有对应的DAG的结点，代表初始值</li>
<li>每个语句s有一个相关的节点N，代表计算得到的值<ul>
<li>N的子节点对应于（其运算分量当前值的）其他语句</li>
<li>节点N的标号是s的运算符</li>
<li>N和一组变量关联，表示s是在此基本块内最晚对它们定值的语句</li>
</ul>
</li>
</ul>
<p>从DAG，可以知道各个变量最后的值和初始值的关系</p>
<p>DAG的构造：</p>
<p><img src="/2024/12/26/compiler-review/image-20241226204948204.png" alt="31"></p>
<p>消除局部公共子表达式：</p>
<ul>
<li>在建立某个节点M之前，检查是否存在一个节点N，它和M具有相同的运算符和子节点（顺序也相同）</li>
<li>如果存在，则不需要生成新的节点，用N代表M</li>
</ul>
<p>消除死代码：在DAG上消除没有附加活跃变量的根节点</p>
<p>应用代数恒等式的优化</p>
<p>数组引用的DAG表示：</p>
<p><img src="/2024/12/26/compiler-review/image-20241226205748401.png" alt="32"></p>
<p><img src="/2024/12/26/compiler-review/image-20241226205906764.png" alt="33"></p>
<p>指针赋值&#x2F;过程调用</p>
<p>重组基本块：</p>
<ul>
<li>每个节点构造一个三地址语句，计算对应的值</li>
<li>结果应该尽量赋给一个活跃的变量</li>
<li>如果节点有多个关联的变量，则需要用复制语句进行赋值</li>
</ul>
<p><img src="/2024/12/26/compiler-review/image-20241226210336656.png" alt="34"></p>
<p><img src="/2024/12/26/compiler-review/image-20241226210443928.png" alt="35"></p>
<p>重组时需要注意求值的顺序</p>
<ul>
<li>指令的顺序必须遵守DAG中结点的顺序</li>
<li>对数组的赋值必须跟在所有原来在它之前的赋值&#x2F;求值操作之后</li>
<li>对数组元素的求值必须跟在所有原来在它之前的赋值指令之后</li>
<li>对变量的使用必须跟在所有原来在它之前的过程调用和指针间接赋值之后</li>
<li>任何过程调用或者指针间接赋值必须跟在原来在它之前的变量求值之后</li>
</ul>
<h3 id="6-6-基本块的代码生成器"><a href="#6-6-基本块的代码生成器" class="headerlink" title="6.6 基本块的代码生成器"></a>6.6 基本块的代码生成器</h3><p>主要目标：尽量减少加载和保存指令，即最大限度利用寄存器</p>
<p>寄存器的使用方法：</p>
<ul>
<li>执行运算时，运算分量必须放在寄存器中</li>
<li>用于临时变量</li>
<li>存放全局的值</li>
<li>进行运行时刻管理（比如：栈顶指针）</li>
</ul>
<p>基本思路：依次考虑各三地址指令，尽可能把值保留在寄存器中，以减少寄存器&#x2F;内存之间的数据交换</p>
<p>基本数据结构：记录各个值对应的位置</p>
<ul>
<li>寄存器描述符：跟踪各个寄存器都存放了哪些变量的当前值</li>
<li>地址描述符：某个变量的当前值存放在哪个或哪些位置（包括内存位置和寄存器）上</li>
</ul>
<p>代码生成算法：</p>
<ul>
<li>遍历三地址指令</li>
<li>使用getReg（）函数选择寄存器</li>
<li>生成指令</li>
</ul>
<p>getReg（I）函数：</p>
<ul>
<li>根据寄存器描述符和地址描述符、数据流信息，为三地址指令I选择最佳的寄存器</li>
<li>得到的机器指令的质量依赖于getReg函数选取的寄存器的算法</li>
</ul>
<p>具体操作步骤：</p>
<p><img src="/2024/12/26/compiler-review/image-20241226211659625.png" alt="36"></p>
<p><img src="/2024/12/26/compiler-review/image-20241226211706659.png" alt="37"></p>
<p><img src="/2024/12/26/compiler-review/image-20241226211714351.png" alt="38"></p>
<p>实例：</p>
<p><img src="/2024/12/26/compiler-review/image-20241226211739967.png" alt="39"></p>
<p>getReg函数详解：</p>
<p><img src="/2024/12/26/compiler-review/image-20241227203429561.png" alt="40"></p>
<p><img src="/2024/12/26/compiler-review/image-20241227203438501.png" alt="41"></p>
<p><img src="/2024/12/26/compiler-review/image-20241227203446103.png" alt="42"></p>
<p><img src="/2024/12/26/compiler-review/image-20241227203503021.png" alt="43"></p>
<p>窥孔优化：使用一个滑动窗口来检查目标指令，在窥孔内实现优化</p>
<ul>
<li>冗余指令消除</li>
<li>控制流优化</li>
<li>代数简化</li>
<li>机器特有指令的使用</li>
</ul>
<p>寄存器分配和指派：</p>
<ul>
<li><p>简单的基本方法：把特定类型的值分配给特定的寄存器</p>
<p>缺点：寄存器的使用效率较低</p>
</li>
<li><p>全局寄存器分配：在循环中频繁使用的值存放在固定寄存器；分配固定多个寄存器来存放内部循环中最活跃的值。可以通过使用计数的方法来估算把一个变量放到寄存器中会带来多大好处，然后根据这个估算来分配寄存器</p>
</li>
</ul>
<p>使用计数</p>
<p>重写</p>
<h2 id="7-代码优化"><a href="#7-代码优化" class="headerlink" title="7.代码优化"></a>7.代码优化</h2><p>本章主要包括优化的来源、数据流分析和机器无关的优化</p>
<h3 id="7-1-优化的来源"><a href="#7-1-优化的来源" class="headerlink" title="7.1 优化的来源"></a>7.1 优化的来源</h3><p>代码优化是在目标代码中消除不必要的指令，把一个指令序列替换为一个完成相同功能的更快的指令序列。</p>
<p>编译器只能通过一些相对低层的语义等价转换来优化代码。</p>
<p>冗余运算的原因：源程序中的冗余；高级程序设计语言编程的副产品。</p>
<p>下面是语义不变的优化方法：</p>
<h3 id="7-2-全局公共子表达式"><a href="#7-2-全局公共子表达式" class="headerlink" title="7.2 全局公共子表达式"></a>7.2 全局公共子表达式</h3><p>如果E在某次出现之前必然已经被计算过，且E的分量在该次计算之后一直没有被改变，那么E的本次出现就是一个公共子表达式。</p>
<p>如果上一次E的值赋给了x，且x的值至今没有被修改过，那么我们就可以使用x，而不需要计算E。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228092910723.png" alt="44"></p>
<h3 id="7-3-复制传播"><a href="#7-3-复制传播" class="headerlink" title="7.3 复制传播"></a>7.3 复制传播</h3><p>形如u&#x3D;v的复制语句使得语句后面的程序点上，u的值等于v的值。如果在某个位置上u一定等于v，那么可以把u替换为v。有时可以彻底消除对u的使用，从而消除对u的赋值语句。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228093124550.png" alt="45"></p>
<h3 id="7-4-死代码消除"><a href="#7-4-死代码消除" class="headerlink" title="7.4 死代码消除"></a>7.4 死代码消除</h3><p>如果一个变量在某个程序点上的值可能会在之后被使用，那么这个变量在这个点上活跃；否则这个变量就是死的，此时对这个变量的赋值就是没有用的死代码。</p>
<p>死代码多半是因为前面的优化而形成的。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228093333158.png" alt="46"></p>
<h3 id="7-5-代码移动"><a href="#7-5-代码移动" class="headerlink" title="7.5 代码移动"></a>7.5 代码移动</h3><p>循环不变表达式：循环的同一次运行的不同迭代中，表达式的值不变。</p>
<p>把循环不变表达式移动到循环入口之前计算可以提高效率。</p>
<p>循环入口：进入循环的跳转都以这个入口为目标。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228093525542.png" alt="47"></p>
<h3 id="7-6-归纳变量和强度消减"><a href="#7-6-归纳变量和强度消减" class="headerlink" title="7.6 归纳变量和强度消减"></a>7.6 归纳变量和强度消减</h3><p>每次对x的赋值都使得x的值增加c，那么x就是归纳变量。把对x的赋值改成增量操作，可消减计算强度，提高效率。如果两个归纳变量步调一致，还可以删除其中的某一个。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228093835971.png" alt="48"></p>
<h3 id="7-7-数据流分析"><a href="#7-7-数据流分析" class="headerlink" title="7.7 数据流分析"></a>7.7 数据流分析</h3><p>数据流分析是用于获取数据沿着程序执行路径流动的信息的相关技术，是优化的基础。</p>
<h4 id="7-7-1-数据流分析理论与框架"><a href="#7-7-1-数据流分析理论与框架" class="headerlink" title="7.7.1 数据流分析理论与框架"></a>7.7.1 数据流分析理论与框架</h4><p>在基本块中，数据的流动是线性的；全局的情况下，因存在循环、函数调用等情况，数据的流动变得复杂。</p>
<p>抽象解释框架：单调性、有界性</p>
<ul>
<li>程序状态是有限的</li>
<li>状态的变化是单调的</li>
</ul>
<p>理论：集合理论、偏序关系与半格</p>
<h4 id="7-7-2-数据流抽象"><a href="#7-7-2-数据流抽象" class="headerlink" title="7.7.2 数据流抽象"></a>7.7.2 数据流抽象</h4><p>程序点：三地址语句之前或之后的位置</p>
<ul>
<li>基本块内部：一个语句之后的程序点等于下一个语句之前的程序点</li>
<li>如果流图中有B1到B2的边，那么B2的第一个语句之前的点可能紧跟在B1的最后语句之后的点后面执行</li>
</ul>
<p>程序状态：在某个运行时刻，当指令指针指向这个程序点时，各个变量和动态内存中存放的值。</p>
<p>指令指针可能多次指向同一个程序点，因此一个程序点可能对应多个程序状态。</p>
<p>数据流分析把可能出现在某个程序点上的程序状态集合总结为一些特性。</p>
<h4 id="7-7-3-数据流分析模式"><a href="#7-7-3-数据流分析模式" class="headerlink" title="7.7.3 数据流分析模式"></a>7.7.3 数据流分析模式</h4><p>数据流值：某个程序点所有可能的状态集合的抽象表示。</p>
<p>域：所有可能的数据流值的集合。</p>
<p>数据流分析：对一组约束求解。</p>
<ul>
<li>IN[s]和OUT[s]</li>
</ul>
<p>基于语句语义的约束（传递函数）：</p>
<ul>
<li>IN[s] &#x3D; f_s(OUT[s])</li>
<li>OUT[s] &#x3D; f_s(IN[s])</li>
</ul>
<p>基于控制流的约束：</p>
<ul>
<li>IN[s_{i+1}] &#x3D; OUT[s_i]</li>
</ul>
<p>基本块上的数据流模式：</p>
<ul>
<li>基本块的控制流从头到尾不会中断，没有分支</li>
<li>基本块的效果就是各个语句的效果的复合</li>
<li>可以预先处理基本块内部的数据流关系，给出基本块对应的传递函数</li>
</ul>
<p>基本块之间的控制流约束：</p>
<ul>
<li>前向数据流问题：<ul>
<li>B的传递函数根据IN[B]计算得到OUT[B]</li>
<li>IN[B]和B的各前驱基本块的OUT值之间具有约束关系</li>
</ul>
</li>
<li>逆向数据流问题：<ul>
<li>B的传递函数根据OUT[B]计算得到IN[B]</li>
<li>OUT[B]和B的各后驱基本块的IN值之间具有约束关系</li>
</ul>
</li>
</ul>
<p><img src="/2024/12/26/compiler-review/image-20241228100214344.png" alt="49"></p>
<p>数据流方程通常没有唯一解。</p>
<h4 id="7-7-4-数据流分析框架"><a href="#7-7-4-数据流分析框架" class="headerlink" title="7.7.4 数据流分析框架"></a>7.7.4 数据流分析框架</h4><p>一个数据流分析框架（D，V，R，F）由下列元素组成：</p>
<ul>
<li>一个数据流方向D，包括前向和后向</li>
<li>一个半格（V，R）:V是程序状态的集合，R是集合的交运算或并运算，用于表示在基本块入口处对不同的前驱（或在出口处对不同的后驱）的程序状态的合并</li>
<li>一个从V到V的传递函数族F，用于刻画基本块内部每条语句对程序状态造成的变化</li>
</ul>
<p>May分析：用于分析在某一程序点上所有可能存在的程序状态。</p>
<p>Must分析：用于分析在某一程序点上一定存在的程序状态。</p>
<h4 id="7-7-5-到达定值分析"><a href="#7-7-5-到达定值分析" class="headerlink" title="7.7.5 到达定值分析"></a>7.7.5 到达定值分析</h4><p>如果存在一条从定值d后面的程序点到达某个点p的路径，且这条路径上d没有被杀死，那么定值d到达p。</p>
<p>杀死：路径上对x的其他定值杀死了之前对x的定值。</p>
<p>直观含义（define-use关系）：如果d到达p，那么在p点使用的值就可能是由d定值的。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228101552867.png" alt="50"></p>
<p>应用：循环不变代码外提、常量传播等等。</p>
<p>语句&#x2F;基本块的传递方程：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228102238234.png" alt="51"></p>
<p><img src="/2024/12/26/compiler-review/image-20241228102245274.png" alt="52"></p>
<p>gen和kill的例子：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228102315516.png" alt="53"></p>
<p>到达定值的控制流方程：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228102924515.png" alt="54"></p>
<p><img src="/2024/12/26/compiler-review/image-20241228102941794.png" alt="55"></p>
<h4 id="7-7-6-活跃变量分析"><a href="#7-7-6-活跃变量分析" class="headerlink" title="7.7.6 活跃变量分析"></a>7.7.6 活跃变量分析</h4><p>分析x在p上的值是否会在某条从p出发的路径中使用。</p>
<p>一个变量x在p上活跃，当且仅当存在一条从p点开始的路径，该路径的末端使用了x，且路径上没有对x进行覆盖。</p>
<p>用途：寄存器分配、死代码删除等等。</p>
<p>数据流值：活跃变量的集合。</p>
<p>基本块内的数据流方程：基本块的传递函数仍然是生成——杀死形式，但是从OUT值计算出IN值。</p>
<ul>
<li>use_B：可能在B中先于定值被使用（gen）</li>
<li>def_B：在B中一定先于定值被使用（kill）</li>
</ul>
<p>示例：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228104410581.png" alt="56"></p>
<p><img src="/2024/12/26/compiler-review/image-20241228104452689.png" alt="57"></p>
<p>活跃变量数据流方程：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228104521883.png" alt="58"></p>
<h4 id="7-7-7-可用表达式分析"><a href="#7-7-7-可用表达式分析" class="headerlink" title="7.7.7 可用表达式分析"></a>7.7.7 可用表达式分析</h4><p>x+y在p点可用的条件：从流图入口节点到达p的每条路径都对x+y求值，且在最后一次求值之后再没有对x或者y赋值。</p>
<p>用途：寻找全局公共子表达式。</p>
<p>生成——杀死：</p>
<ul>
<li>杀死：基本块对x或y赋值，且没有重新计算x+y，那么它就杀死了x+y</li>
<li>生成：基本块求值x+y，且之后没有对x或y赋值，那么它就生成了x+y</li>
</ul>
<p>计算基本块生成的表达式：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228105125226.png" alt="59"></p>
<p>示例：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228105302443.png" alt="60"></p>
<p>可用表达式的数据流方程：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228105329046.png" alt="61"></p>
<p>三种数据流方程的总结：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228105347224.png" alt="62"></p>
<h3 id="7-8-机器无关的优化"><a href="#7-8-机器无关的优化" class="headerlink" title="7.8 机器无关的优化"></a>7.8 机器无关的优化</h3><h4 id="7-8-1-局部优化"><a href="#7-8-1-局部优化" class="headerlink" title="7.8.1 局部优化"></a>7.8.1 局部优化</h4><p>局部优化包括：DAG、公共子表达式消除、无用代码消除、常量折叠、代数恒等式替换等。</p>
<h4 id="7-8-2-全局优化"><a href="#7-8-2-全局优化" class="headerlink" title="7.8.2 全局优化"></a>7.8.2 全局优化</h4><p>全局优化管道：常量传播——公共子表达式消除——复制传播——常量折叠——控制流优化——无用代码消除——循环不变代码外提——归纳变量强度消减——控制流优化。</p>
<p>常量传播框架中的变量状态分为三种：</p>
<ul>
<li>所有符合该变量类型的常量值</li>
<li>NAC（Not A Constant）表示当前变量不是一个常量值，这代表该变量在到达程序点p的不同路径上的值不同，或是被赋予了一个输入变量的值</li>
<li>UNDEF，表示未定义的值。在到达程序点p的不同路径上存在至少一条路径未对变量的值进行定义</li>
</ul>
<h4 id="7-8-3-循环优化"><a href="#7-8-3-循环优化" class="headerlink" title="7.8.3 循环优化"></a>7.8.3 循环优化</h4><p>支配节点（必经节点）：</p>
<p><img src="/2024/12/26/compiler-review/image-20241228130435331.png" alt="63"></p>
<p>支配节点树：可以表示支配关系。根节点是入口节点，每个节点d支配且只支配树中的后代节点。</p>
<p>直接支配节点：从入口节点到达n的任何路径中，它是路径中最后一个支配n的节点。</p>
<p><img src="/2024/12/26/compiler-review/image-20241228130732424.png" alt="64"></p>
<p>深度优先排序</p>
<p>回边和可归约性</p>
<p>自然循环</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">ycvenopyer</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://ycvenopyer.github.io/2024/12/26/compiler-review/">http://ycvenopyer.github.io/2024/12/26/compiler-review/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">ycvenopyer</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Compiler/">
                                    <span class="chip bg-color">Compiler</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'aGPQgRQVqLc5dx4lWY57DnTB-gzGzoHsz',
        appKey: 'EiJqmaaDHxFxX8Ut0FLcVJNB',
        serverURLs: 'https://agpqgrqv.lc-cn-n1-shared.com',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/12/27/foundations-of-data-science-review/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="2024 Fall Foundations of Data Science Review">
                        
                        <span class="card-title">2024 Fall Foundations of Data Science Review</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-12-27
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/TCS/" class="post-category">
                                    TCS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Probability/">
                        <span class="chip bg-color">Probability</span>
                    </a>
                    
                    <a href="/tags/Random-Process/">
                        <span class="chip bg-color">Random Process</span>
                    </a>
                    
                    <a href="/tags/Statistics/">
                        <span class="chip bg-color">Statistics</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/12/25/software-testing-review/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="2024 Fall Software Testing Review">
                        
                        <span class="card-title">2024 Fall Software Testing Review</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-12-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Software-Engineering/" class="post-category">
                                    Software Engineering
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Software-Testing/">
                        <span class="chip bg-color">Software Testing</span>
                    </a>
                    
                    <a href="/tags/Automated-Testing/">
                        <span class="chip bg-color">Automated Testing</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('128')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: ycvenopyer&#39;s Blogs<br />'
            + '文章作者: ycvenopyer<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
    });
</script>



    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="7485542271"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='list'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024-2025</span>
            
            <a href="/about" target="_blank">ycvenopyer</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">40.6k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2024";
                        var startMonth = "8";
                        var startDate = "18";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/ycvenopyer" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:ycvenopyer@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2144192307" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2144192307" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
